# 管家婆辉煌版 LAN 实时扫码查价系统 - 架构与开发需求文档

## 1. 项目背景与目标

本项目旨在为实体门店开发一款轻量级的局域网（LAN）移动端扫码查价工具。门店员工可通过连接店内 WiFi，使用个人手机的浏览器或轻量级 App，直接调用手机摄像头扫描商品条码，实时从本地主机的“管家婆”进销存软件数据库中获取并展示商品名称、规格及售价。

**核心原则**：对管家婆数据库**绝对只读（Read-Only）**，不修改任何底层数据，确保 ERP 系统的数据安全。

## 2. 软硬件基础环境

系统基于客户现有的本地服务器与网络环境运行：

- **宿主 ERP 软件**：管家婆辉煌Ⅱ TOP / 管家婆辉煌门店版 (文件版本: 15.0.0.68)
- **底层数据库**：本地 SQL Server (监听端口 1433)
- **目标核心业务库**：`swcs` (存放基础档案与商品数据的主库)
- **网络环境**：店内局域网（电脑主机与员工手机处于同一 WiFi 路由下）

## 3. 系统架构设计

采用 B/S（Browser/Server）前后端分离架构，或轻量级混合应用架构：

- **数据层 (SQL Server)**：管家婆自带的本地数据库。
- **后端 API 服务层**：
  - **部署位置**：部署在运行管家婆的同一台 Windows 电脑主机上。
  - **推荐技术栈**：C# (.NET Core Web API) 或 Node.js (Express/Koa) —— 具备极佳的 Windows 环境兼容性与轻量化特性。
  - **职责**：负责连接 SQL Server 提供只读查询接口；负责员工账号的简单鉴权（Token/Session）；跨域处理（CORS）；托管前端静态资源（若采用纯 H5 方案）。
- **前端表现层 (Mobile H5 / App)**：
  - **推荐技术栈**：Vue.js 结合 uni-app 框架。
  - **职责**：提供登录界面；调用手机后置摄像头识别条形码；发起 API 请求；在界面上进行大字号的视觉展示与成功/失败的声音反馈。

## 4. 数据库结构与查询逻辑说明

管家婆数据库的设计包含大量动态拼接与自定义函数，以下是逆向分析得出的核心查询逻辑，开发时需重点参考：

### 4.1 核心表与连接方式

- **目标数据库名**：`swcs`
- **目标商品表名**：`Ptype`
- **身份验证方式**：**必须使用 SQL Server 身份验证**（通常账号为 `sa` 或新建的专有只读账号），**不可**使用 Windows 身份验证，否则后端脱离桌面环境运行时会导致权限拒绝。

### 4.2 核心查询 SQL 逻辑

根据底层存储过程（如 `p_hh_GetBaseList` 和 `p_hh_BasicUpdateP`）的参数映射，商品条码查询涉及管家婆内部的自定义函数。

**后端 API 执行的只读查询语句参考模板：**

SQL

```
-- 方案 A：如果条码直接存在 Ptype 表的固定字段中（如 Standard 或 Barcode 字段）
SELECT 
    FullName AS ProductName,   -- 商品全名
    Standard AS Specification, -- 规格/条码
    RetailPrice AS Price       -- 零售价 (具体字段名如 Price1, RetailPrice 需通过 SSMS 确认)
FROM swcs.dbo.Ptype 
WHERE Standard = @ScannedBarcode; -- 必须使用参数化查询防注入

-- 方案 B：如果管家婆启用了多单位/多条码，需调用其内部自定义函数 fn_strunitptype
SELECT 
    p.FullName, 
    -- 提取价格字段
FROM swcs.dbo.Ptype p
-- 'B' 代表 Barcode，该函数通过商品内部 ID (ptypeid) 解析出条码用于比对
WHERE DBO.fn_strunitptype('B', p.ptypeid, 0) = @ScannedBarcode;
```

*(注：开发前，请开发人员使用 SQL Server Management Studio (SSMS) 实际连接 `swcs` 库，执行 `SELECT TOP 10 \* FROM Ptype` 核对具体的价格字段名称。)*

## 5. 功能模块需求

### 5.1 简易权限管理 (Auth)

- 无需复杂的 RBAC 权限。系统内置或在配置文件中预设几个员工账号（如：账号 `user01`，密码 `1234`）。
- 手机端首次访问需登录，登录后在本地缓存 Token，保持登录状态。

### 5.2 移动端扫码与展示 (UI/UX)

- **全屏扫码**：主界面需包含实时摄像头预览区域（调用 `html5-qrcode` 等扫码库）。
- **连续工作流**：扫码成功后，无需点击确认，系统自动发起请求。
- **视觉与听觉反馈**：
  - 门店环境可能较为嘈杂，查询成功时，不仅要在屏幕用**极大号加粗字体**显示名称和价格，还必须触发一次“滴”的成功提示音。
  - 条码不存在或网络错误时，屏幕背景变红，并触发错误提示音。
  - 查询结果展示 3 秒后（或点击屏幕任意位置），自动恢复至可扫码状态。

## 6. 核心技术难点与基建要求（避坑指南）

开发与部署过程中，必须严格处理以下三个前置条件，否则系统无法在局域网内运行：

1. **主机静态 IP 绑定**：必须在店内路由器的 DHCP 设置中，将管家婆主机的 MAC 地址与本地 IP（如 `192.168.1.100`）绑定，防止 IP 变动导致员工手机访问失败。
2. **Windows 防火墙放行**：必须在主机的 Windows 高级防火墙中添加入站规则，开放后端 API 监听的端口（如 `8080` 或 `5000`）。
3. **【致命点】手机浏览器摄像头权限限制（HTTPS 协议约束）**：
   - **问题描述**：现代 iOS 与 Android 浏览器处于安全策略限制，若访问地址为局域网 IP（非 localhost）且**未开启 HTTPS**，将强制拦截 `getUserMedia` API，导致网页无法调用手机摄像头。
   - **强制解决方案（二选一）**：
     - **路线 1（Web 原生路线）**：后端必须配置自签名的 SSL 证书以启用 HTTPS。员工手机首次访问时需手动忽略浏览器的“证书不安全”警告。
     - **路线 2（App 封装路线 - 强烈推荐）**：由于目标是内部工具，建议直接利用 Vue 结合 uni-app，将前端直接打包生成一个微型的 Android `.apk` 文件供员工安装。此方案彻底绕过浏览器的 HTTPS 限制，直接调用原生摄像头权限，扫码速度更快，体验最佳。

