# SWCS 字段映射速查

本文用于快速回答 3 个问题：

1. 这个参数查的是哪个字段？
2. 这个字段在什么库、什么表？
3. 返回结果里的每个字段来自哪里？

## 1. 数据库与核心表

- 数据库：`dwpfbcs`
  - 来源：`backend/src/SwcsScanner.Api/appsettings.Production.json`
  - 键：`ConnectionStrings:SwcsReadonly`

- 商品主表：`dbo.Ptype`（别名 `p`）
  - 来源：`Swcs:ProductTable`

- 条码表：`xw_PtypeBarCode`（别名 `bc`）
  - 来源：`Swcs:BarcodeTable`

- 价格表：`xw_P_PtypePrice`（别名 `prRaw` / `pr`）
  - 来源：`Swcs:PriceTable`

- 单位表：`dbo.xw_PtypeUnit`（别名 `u`）
  - 来源：仓储 SQL（用于单位明细展示）

## 2. 关键配置参数 -> 字段映射

配置文件：`backend/src/SwcsScanner.Api/appsettings.Production.json`

- `Swcs:ProductTable = dbo.Ptype`
  - 商品基础字段从这个表读取。

- `Swcs:ProductNameField = pfullname`
  - 商品名称字段。
  - 返回到接口字段：`productName`。

- `Swcs:SpecificationField = Standard`
  - 规格字段。
  - 返回到接口字段：`specification`。

- `Swcs:BarcodeTable = xw_PtypeBarCode`
- `Swcs:BarcodeColumn = BarCode`
  - 条码字段。
  - `lookup` 精确查与 `search` 条码模糊查都使用它。
  - 返回到接口字段：`barcode`（搜索候选项）/ `barcodeMatchedBy`（可能值之一）。

- `Swcs:PriceTable = xw_P_PtypePrice`
- `Swcs:PriceColumn = Price`
- `Swcs:PriceTypeId = 0001`
  - 价格取值逻辑：按 `PTypeId + UnitID` 关联，优先 `PRTypeId=0001`。
  - 返回到接口字段：`price`。

## 3. 新增能力字段（本次改造）

定义位置：`backend/src/SwcsScanner.Api/Data/SwcsProductLookupRepository.cs`

- 商品编号字段：`pusercode`
  - 代码常量：`ProductCodeFieldName = "pusercode"`
  - 返回到接口字段：`productCode`

- 商品缩写码字段：`pnamepy`
  - 代码常量：`ProductShortCodeFieldName = "pnamepy"`
  - 返回到接口字段：`productShortCode`

说明：

- 这两个字段当前是代码常量，不是 appsettings 配置项。
- 若库里不存在这两列，接口会返回空字符串，不会报错。

## 4. 接口参数 -> 查询字段

控制器：`backend/src/SwcsScanner.Api/Controllers/ProductsController.cs`

- `GET /api/products/lookup?barcode=xxx`
  - 参数：`barcode`
  - 主要匹配字段：`xw_PtypeBarCode.BarCode`（精确）
  - 兜底路径：根据配置或兼容逻辑做额外尝试（函数/组合字段）。

- `GET /api/products/search?keyword=xxx&limit=20`
  - 参数：`keyword`
  - 最小长度：2
  - 当前（有条码表模式）模糊匹配字段：
    - `xw_PtypeBarCode.BarCode`
    - `dbo.Ptype.pnamepy`（缩写码）
    - `dbo.Ptype.pusercode`（商品编号）
    - `dbo.Ptype.pfullname`（商品全名）

## 5. 返回字段 -> 来源

### 5.1 `/api/products/lookup` 返回

- `productName` <- `dbo.Ptype.pfullname`（由 `Swcs:ProductNameField` 决定）
- `productCode` <- `dbo.Ptype.pusercode`
- `productShortCode` <- `dbo.Ptype.pnamepy`
- `specification` <- `dbo.Ptype.Standard`（由 `Swcs:SpecificationField` 决定）
- `price` <- `xw_P_PtypePrice.Price`（按 `PTypeId + UnitID` + `PRTypeId`优先级）
- `barcodeMatchedBy` <- 命中字段标识（如 `BarCode`、`pnamepy`、`pusercode`、`pfullname` 等）

### 5.2 `/api/products/search` 返回项

- `productName` <- `dbo.Ptype.pfullname`
- `productCode` <- `dbo.Ptype.pusercode`
- `productShortCode` <- `dbo.Ptype.pnamepy`
- `specification` <- `dbo.Ptype.Standard`
- `price` <- `xw_P_PtypePrice.Price`
- `barcode` <- 当前候选对应条码（条码表模式下来自 `xw_PtypeBarCode.BarCode`）
- `barcodeMatchedBy` <- 本条候选的命中字段标识

## 6. 给你日常排查的最短路径

1. 看当前连接哪个库：
   - `backend/src/SwcsScanner.Api/appsettings.Production.json`
2. 看字段和表怎么映射：
   - `backend/src/SwcsScanner.Api/Data/SwcsProductLookupRepository.cs`
3. 看接口参数和返回模型：
   - `backend/src/SwcsScanner.Api/Controllers/ProductsController.cs`
   - `backend/src/SwcsScanner.Api/Models/Responses/ProductLookupResponse.cs`
   - `backend/src/SwcsScanner.Api/Models/Responses/ProductSearchItemResponse.cs`
