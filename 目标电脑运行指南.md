# 目标电脑运行指南

适用场景：当前目标机本地运行 SWCS 扫码查价系统，手机同 WiFi 访问。

## 1. 前置条件

1. Windows 可执行 `dotnet`、`node`、`npm`。
2. SQL Server 实例可访问，业务库为 `dwpfbcs`。
3. 项目目录示例：`E:\gjpLocal`。

## 2. 首次部署（只需一次）

### 2.1 生成 HTTPS 证书

```powershell
cd E:\gjpLocal\ops\ps
.\new-self-signed-cert.ps1 -Hostname $env:COMPUTERNAME -IpAddress "192.168.0.188"
```

### 2.2 放行 5001 端口（管理员 PowerShell）

```powershell
cd E:\gjpLocal\ops\ps
.\open-firewall-port.ps1 -Port 5001
```

### 2.3 检查生产配置

文件：`backend/src/SwcsScanner.Api/appsettings.Production.json`

关键项应为：

- `ConnectionStrings:SwcsReadonly` -> `Database=dwpfbcs`
- `Swcs:ProductNameField` -> `pfullname`
- `Swcs:PriceTypeId` -> `0001`
- `Swcs:BarcodeTable` -> `xw_PtypeBarCode`

## 3. 启动方式

### 3.1 推荐：一键启动 bat

首次（带前端构建）：

```bat
start-all.bat
```

日常（不构建前端）：

```bat
start-all.bat nobuild
```

### 3.2 脚本原理

`start-all.bat` 实际调用：

```powershell
ops/ps/init-and-start.ps1 -BuildFrontend -Environment Production
```

或：

```powershell
ops/ps/init-and-start.ps1 -BuildFrontend:$false -Environment Production
```

## 4. 验收

1. 本机：`https://localhost:5001/api/health` 返回 `ok`。
2. 手机同 WiFi 打开：`https://<本机IP>:5001`。
3. 手机需安装并信任证书：`backend/src/SwcsScanner.Api/certs/swcs-scanner.cer`。

## 5. 开机自启/服务化

你问的“是不是每次开机都要手工跑命令”：

- 默认是需要。
- 建议改成“开机自启任务”或“Windows 服务”。

### 5.1 方案 A：任务计划程序（最省事）

1. 打开“任务计划程序” -> 创建任务。
2. 触发器：开机时。
3. 操作：启动程序。
4. 程序填：`cmd.exe`
5. 参数填：`/c E:\gjpLocal\start-all.bat nobuild`
6. 勾选“使用最高权限运行”。

### 5.2 方案 B：Windows 服务（NSSM）

安装 NSSM 后执行（管理员命令行）：

```bat
nssm install SwcsScanner powershell.exe
nssm set SwcsScanner AppDirectory E:\gjpLocal
nssm set SwcsScanner AppParameters "-NoProfile -ExecutionPolicy Bypass -File E:\gjpLocal\ops\ps\init-and-start.ps1 -BuildFrontend:$false -Environment Production"
nssm set SwcsScanner Start SERVICE_AUTO_START
nssm start SwcsScanner
```

说明：

- 这会把后端改为系统服务开机自启。
- 前端静态文件沿用上次构建结果（`nobuild`）。
- 如果前端有更新，手工跑一次 `start-all.bat` 即可。

## 6. 停止服务

- 控制台运行时：`Ctrl + C`
- NSSM 服务：

```bat
nssm stop SwcsScanner
```
