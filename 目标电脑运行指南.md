# 目标电脑运行指南

适用场景：当前目标机本地运行 SWCS 扫码查价系统，手机同 WiFi 访问。

## 1. 前置条件

1. Windows 可执行 `dotnet`、`node`、`npm`。
2. SQL Server 实例可访问，业务库为 `dwpfbcs`。
3. 项目目录示例：`E:\gjpLocal`。

## 2. 首次部署（只需一次）

### 2.1 生成 HTTPS 证书

```powershell
cd E:\gjpLocal\ops\ps
.\new-self-signed-cert.ps1 -Hostname $env:COMPUTERNAME -IpAddress "192.168.0.188"
```

### 2.2 放行 5001 端口（管理员 PowerShell）

```powershell
cd E:\gjpLocal\ops\ps
.\open-firewall-port.ps1 -Port 5001
```

### 2.3 检查生产配置

文件：`backend/src/SwcsScanner.Api/appsettings.Production.json`

关键项应为：

- `ConnectionStrings:SwcsReadonly` -> `Database=dwpfbcs`
- `Swcs:ProductNameField` -> `pfullname`
- `Swcs:PriceTypeId` -> `0001`
- `Swcs:BarcodeTable` -> `xw_PtypeBarCode`

## 3. 启动方式

### 3.1 推荐：一键启动 bat

首次（带前端构建）：

```bat
start-all.bat
```

日常（不构建前端）：

```bat
start-all.bat nobuild
```

### 3.2 脚本原理

`start-all.bat` 实际调用：

```powershell
ops/ps/init-and-start.ps1 -BuildFrontend -Environment Production
```

或：

```powershell
ops/ps/init-and-start.ps1 -BuildFrontend:$false -Environment Production
```

## 4. 验收

1. 本机：`https://localhost:5001/api/health` 返回 `ok`。
2. 手机同 WiFi 打开：`https://<本机IP>:5001`。
3. 手机需安装并信任证书：`backend/src/SwcsScanner.Api/certs/swcs-scanner.cer`。

## 5. 开机自启/服务化

你问的“是不是每次开机都要手工跑命令”：

- 默认是需要。
- 现在已支持一键安装“Windows 服务”。

### 5.1 方案 A：Windows 服务（推荐）

管理员 PowerShell：

```powershell
cd E:\gjpLocal
.\ops\ps\install-windows-service.ps1 -BuildFrontend -Environment Production
```

或管理员命令行：

```bat
cd /d E:\gjpLocal
install-service.bat
```

脚本会自动做这些事：

1. 前端构建并拷贝到后端 `wwwroot`
2. 发布后端到 `C:\Services\SwcsScanner`
3. 安装/更新服务 `SwcsScanner`
4. 设置开机自启（Automatic）
5. 启动服务

### 5.2 卸载服务

```bat
cd /d E:\gjpLocal
uninstall-service.bat
```

或者管理员 PowerShell：

```powershell
.\ops\ps\uninstall-windows-service.ps1
```

## 6. 服务状态与验证

查看服务状态：

```powershell
Get-Service SwcsScanner
```

健康检查：

```powershell
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
Invoke-RestMethod https://localhost:5001/api/health
```

## 7. 服务化后能否删除 `E:\gjpLocal`？

可以，但有前提：

1. 服务已成功安装并能正常启动。
2. 服务运行目录 `C:\Services\SwcsScanner` 不要删除。

原因：

- 运行中的服务读取的是 `C:\Services\SwcsScanner` 的发布文件，不再依赖源码目录。
- 以后若要升级版本，建议保留源码目录或留一份备份仓库。
