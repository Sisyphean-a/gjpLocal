# 目标电脑运行指南（最终版）

适用场景：你已经把项目代码拷到目标电脑，目标电脑本身已有 `swcs` 数据库。  
默认：**不恢复数据库**。

## 1. 必做前置

1. 以管理员身份打开 PowerShell。
2. 进入项目目录（示例）：

```powershell
cd D:\swcs-scanner
```

3. 确认目录存在：`backend`、`frontend`、`ops`、`docs`。

## 2. 生成 HTTPS 证书

先查目标电脑局域网 IP：

```powershell
ipconfig
```

执行证书脚本（把 IP 改成你的）：

```powershell
cd D:\swcs-scanner\ops\ps
.\new-self-signed-cert.ps1 -Hostname $env:COMPUTERNAME -IpAddress "192.168.1.100"
```

## 3. 修改生产配置（必须）

编辑文件：`backend/src/SwcsScanner.Api/appsettings.Production.json`，只改这 4 项：

1. `ConnectionStrings:SwcsReadonly`  
2. `Auth:Users`  
3. `Jwt:Key`（至少 32 位）  
4. `Https:PfxPassword`（要和生成证书时一致）  

## 4. 放行端口

```powershell
cd D:\swcs-scanner\ops\ps
.\open-firewall-port.ps1 -Port 5001
```

## 5. 启动项目

首次建议执行（会构建前端并复制到后端）：

```powershell
cd D:\swcs-scanner\ops\ps
.\init-and-start.ps1 -BuildFrontend -Environment Production
```

后续日常启动（不重建前端）：

```powershell
cd D:\swcs-scanner\ops\ps
.\init-and-start.ps1 -BuildFrontend:$false -Environment Production
```

`init-and-start.ps1` 会先检查配置、证书和数据库关键对象，检查通过后再启动服务（默认不会修改数据库）。

## 6. 验收

1. 目标电脑本机打开：

```text
https://localhost:5001/api/health
```

看到 `status: ok` 即后端正常。

2. 手机与目标电脑同一 WiFi，打开：

```text
https://<目标电脑IP>:5001
```

3. 手机上安装并信任 `backend/src/SwcsScanner.Api/certs/swcs-scanner.cer` 后再扫码测试。

## 7. 只看这两条故障排查

1. 手机打不开页面：检查目标电脑 IP 和 5001 防火墙。  
2. 页面打开但不能扫码：确认是 `HTTPS`，并已给浏览器相机权限。  

## 8. 说明

`ops/sql/restore_swcs.sql` 只在数据库损坏或你明确要回滚备份时才用。  
你当前场景正常上线不需要执行恢复。
